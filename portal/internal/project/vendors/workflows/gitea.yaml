name: litefunctions ci

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: litefunctions-zot:5000
  IMAGE_PREFIX: ashudev
  PORTAL_RUNTIME_ASSETS_URL: http://litefunctions-portal:3000/api/runtime-assets/runtimes.tar.gz

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.changes.outputs.rust }}
      go: ${{ steps.changes.outputs.go }}
      rust-files: ${{ steps.get-changed-files.outputs.rust-files }}
      go-files: ${{ steps.get-changed-files.outputs.go-files }}
      repo_name: ${{ steps.set-repo-name.outputs.repo_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            rust:
              - 'functions/rs/**'
            go:
              - 'functions/go/**'

      - name: Get changed files
        id: get-changed-files
        run: |
          BEFORE_SHA=${{ gitea.event.before || '0000000000000000000000000000000000000000' }}

          RUST_FILES_JSON=$(git diff --name-only ${BEFORE_SHA}..${{ gitea.sha }} -- 'functions/rs/*.rs' \
            | sed 's|functions/rs/||' | sed 's|\.rs$||' \
            | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "rust-files=${RUST_FILES_JSON:-[]}" >> $GITHUB_OUTPUT

          GO_FILES_JSON=$(git diff --name-only ${BEFORE_SHA}..${{ gitea.sha }} -- 'functions/go/*.go' \
            | sed 's|functions/go/||' | sed 's|\.go$||' \
            | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "go-files=${GO_FILES_JSON:-[]}" >> $GITHUB_OUTPUT
          echo "Detected Rust files JSON: ${RUST_FILES_JSON}"
          echo "Detected Go files JSON: ${GO_FILES_JSON}"

      - name: Set repo name
        id: set-repo-name
        run: |
          REPO_NAME=$(basename "${{ gitea.repository }}")
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

  build-runtime:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - lang: go
            lang_tag: go
            changed: ${{ needs.detect-changes.outputs.go }}
            files_json: ${{ needs.detect-changes.outputs.go-files }}
            context: dir://litefunctions/runtimes/go
            dockerfile: ../../build/runtimes/Dockerfile.go
            source_dir: functions/go
            source_ext: go
            runtime_target: runtimes/go/pkg
          - lang: rs
            lang_tag: rust
            changed: ${{ needs.detect-changes.outputs.rust }}
            files_json: ${{ needs.detect-changes.outputs.rust-files }}
            context: dir://litefunctions/runtimes/rust
            dockerfile: ../../build/runtimes/Dockerfile.rust
            source_dir: functions/rs
            source_ext: rs
            runtime_target: runtimes/rust/src/pkg
    steps:
      - name: Skip unchanged language
        if: matrix.changed != 'true'
        run: |
          echo "No ${{ matrix.lang }} changes detected."
          echo "SKIP_BUILD=true" >> $GITHUB_ENV

      - name: Checkout current repo (this Gitea repo)
        if: matrix.changed == 'true'
        uses: actions/checkout@v4
        with:
          path: current-repo
          
      - name: Setup Kaniko config
        if: matrix.changed == 'true'
        run: |
          mkdir -p $HOME/.docker
          echo '{"auths":{"${{ env.REGISTRY }}":{"auth":"'$(echo -n ${{ env.IMAGE_PREFIX }}:${{ secrets.GITEA_TOKEN }} | base64)'"}}}' > $HOME/.docker/config.json

      - name: Verify Kaniko config (debug)
        if: matrix.changed == 'true'
        run: |
          echo "HOME is: $HOME"
          ls -la $HOME/.docker/
          if [ -f "$HOME/.docker/config.json" ]; then
            echo "config.json exists!"
            cat $HOME/.docker/config.json | sed 's/"auth":"[^"]*"/"auth":"REDACTED"/'
          else
            echo "config.json MISSING!"
          fi

      - name: Prepare build parameters
        if: matrix.changed == 'true'
        env:
          FILES_JSON: ${{ matrix.files_json }}
          LANG: ${{ matrix.lang }}
          LANG_TAG: ${{ matrix.lang_tag }}
          SOURCE_DIR: ${{ matrix.source_dir }}
          SOURCE_EXT: ${{ matrix.source_ext }}
          RUNTIME_TARGET: ${{ matrix.runtime_target }}
          BUILD_CONTEXT: ${{ matrix.context }}
          BUILD_DOCKERFILE: ${{ matrix.dockerfile }}
          REPO_NAME: ${{ needs.detect-changes.outputs.repo_name }}
        run: |
          echo "Detected ${LANG} files JSON: $FILES_JSON"
          file=$(echo "$FILES_JSON" | jq -r '.[0]')

          if [ "$file" = "null" ] || [ -z "$file" ]; then
            echo "No valid ${LANG} file detected - skipping build"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
            exit 0
          fi
          LATEST_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/runtime-${LANG_TAG}-$REPO_NAME-$file:latest"
          SHA_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/runtime-${LANG_TAG}-$REPO_NAME-$file:${{ gitea.sha }}"

          echo "Building ${LANG} function: $file"
          echo "Resolved LATEST tag: $LATEST_TAG"
          echo "Resolved SHA tag: $SHA_TAG"

          git clone https://github.com/ashupednekar/litefunctions
          TARGET_FILE="function.${SOURCE_EXT}"
          if [ "$LANG" = "go" ] && grep -Eq "func[[:space:]]+StreamHandler" "current-repo/${SOURCE_DIR}/$file.${SOURCE_EXT}"; then
            TARGET_FILE="function_async.go"
          fi
          echo "Using runtime template: ${TARGET_FILE}"
          cp "current-repo/${SOURCE_DIR}/$file.${SOURCE_EXT}" \
             "litefunctions/${RUNTIME_TARGET}/${TARGET_FILE}"

          echo "FUNCTION_NAME=$file" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "SHA_TAG=$SHA_TAG" >> $GITHUB_ENV
          echo "BUILD_CONTEXT=$BUILD_CONTEXT" >> $GITHUB_ENV
          echo "BUILD_DOCKERFILE=$BUILD_DOCKERFILE" >> $GITHUB_ENV

      - name: Build and Push with Kaniko
        if: env.SKIP_BUILD != 'true'
        uses: docker://gcr.io/kaniko-project/executor:latest
        with:
          args: >
            --context=${{ env.BUILD_CONTEXT }}
            --dockerfile=${{ env.BUILD_DOCKERFILE }}
            --destination=${{ env.LATEST_TAG }}
            --destination=${{ env.SHA_TAG }}
            --build-arg PROJECT=${{ needs.detect-changes.outputs.repo_name }}
            --build-arg NAME=${{ env.FUNCTION_NAME }}
            --build-arg GIT_TOKEN=${{ secrets.GITEA_TOKEN }}
            --cache=true
            --cache-copy-layers=true
            --cache-ttl=336h
            --insecure
            --skip-tls-verify
            --skip-push-permission-check
            --verbosity=debug

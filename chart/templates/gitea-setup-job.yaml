{{- if .Values.gitea.enabled | default false }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "litefunctions.fullname" . }}-gitea-setup
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "2"
spec:
  template:
    spec:
      containers:
      - name: gitea-setup
        image: docker.gitea.com/gitea:1.24.6-rootless
        command:
        - sh
        - -c
        - |
          # Wait for gitea to be ready
          until curl -f http://litefunctions-gitea:3000/api/v1/version; do sleep 5; done
          # Create actions runner token
          gitea --config /tmp/app.ini actions generate-runner-token > /tmp/runner-token
          # You can store or use the token as needed
        env:
        - name: GITEA__database__DB_TYPE
          value: postgres
        - name: GITEA__database__SCHEMA
          value: gitea
        - name: GITEA__database__SSL_MODE
          value: require
        - name: GITEA__database__HOST
          valueFrom:
            secretKeyRef:
              name: litefunctions-pguser-litefunctions
              key: host
        - name: GITEA__database__PASSWD
          valueFrom:
            secretKeyRef:
              name: litefunctions-pguser-litefunctions
              key: password
        - name: GITEA__database__NAME
          valueFrom:
            secretKeyRef:
              name: litefunctions-pguser-litefunctions
              key: dbname
        - name: GITEA__database__USER
          valueFrom:
            secretKeyRef:
              name: litefunctions-pguser-litefunctions
              key: user
        volumeMounts:
        - name: config
          mount: /tmp
      volumes:
      - name: config
        emptyDir: {}
      restartPolicy: Never
{{- end }}
